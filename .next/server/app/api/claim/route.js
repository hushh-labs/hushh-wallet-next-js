"use strict";(()=>{var e={};e.id=139,e.ids=[139],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2276:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>I,originalPathname:()=>w,patchFetch:()=>j,requestAsyncStorage:()=>g,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>_,staticGenerationBailout:()=>v});var a={};r.r(a),r.d(a,{OPTIONS:()=>d,POST:()=>p});var s=r(5419),n=r(9108),i=r(9678),o=r(8070),u=r(6517),l=r(5635);async function c(e){let t=`claim:${e}`,r=new Date,a=new Date(r.getTime()-6e4*r.getMinutes()-1e3*r.getSeconds()-r.getMilliseconds());try{let{data:e}=await u.p.from("rate_limits").select("count, reset_at").eq("bucket",t).single();if(e){if(new Date(e.reset_at)>r){if(e.count>=10)return!1;await u.p.from("rate_limits").update({count:e.count+1}).eq("bucket",t)}else await u.p.from("rate_limits").update({count:1,reset_at:new Date(a.getTime()+36e5).toISOString()}).eq("bucket",t)}else await u.p.from("rate_limits").insert({bucket:t,count:1,reset_at:new Date(a.getTime()+36e5).toISOString()});return!0}catch(e){return console.error("Rate limit check failed:",e),!0}}async function m(e,t,r={}){try{await u.p.from("pass_events").insert({uid:e,type:t,meta_json:r})}catch(e){console.error("Failed to log event:",e)}}async function p(e){try{let t=e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"unknown";if(!await c(t))return o.Z.json({error:"Too many requests. Please try again later."},{status:429});let{name:r,email:a,phone:s}=await e.json();if(!r||!a||!s)return o.Z.json({error:"Name, email, and phone are required."},{status:400});let n=(0,l.pq)({name:r,email:a,phone:s});if(!n)return o.Z.json({error:"Invalid name, email, or phone number format."},{status:400});let i=(0,l.D)(n),p=(0,l.Ux)(),d=(0,l.IR)(p),h=(0,l.AH)(i,p);try{let{data:r}=await u.p.from("members").select("uid, pass_status").eq("uid",i).single();if(r){await m(i,"claim_submitted",{ip:t,existing:!0,user_agent:e.headers.get("user-agent")});let{data:r}=await u.p.from("short_urls").select("short_id").eq("uid",i).single(),a=h.profile_url;return r&&(a=(0,l.Jj)(r.short_id)),o.Z.json({uid:i,addToWalletUrl:`/api/passes/gold?uid=${i}`,profileUrl:a,existing:!0})}let a=(0,l.QB)(),s=(0,l.Jj)(a),{error:c}=await u.p.from("members").insert({uid:i,name:n.name,email:n.email,phone_e164:n.phone_e164,edit_token_hash:d,public_url:h.public_url,profile_url:s,pass_status:"active"});if(c)return console.error("Failed to create member:",c),o.Z.json({error:"Failed to create member account."},{status:500});return await u.p.from("short_urls").insert({short_id:a,uid:i,token:p}),await m(i,"claim_submitted",{ip:t,user_agent:e.headers.get("user-agent"),utm_source:e.nextUrl.searchParams.get("utm_source"),utm_medium:e.nextUrl.searchParams.get("utm_medium"),utm_campaign:e.nextUrl.searchParams.get("utm_campaign")}),o.Z.json({uid:i,addToWalletUrl:`/api/passes/gold?uid=${i}`,profileUrl:s,existing:!1})}catch(e){return console.error("Database error:",e),o.Z.json({error:"Database operation failed."},{status:500})}}catch(e){return console.error("Claim API error:",e),o.Z.json({error:"Internal server error."},{status:500})}}async function d(){return o.Z.json({},{status:200})}let h=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/claim/route",pathname:"/api/claim",filename:"route",bundlePath:"app/api/claim/route"},resolvedPagePath:"/Users/ankitkumarsingh/Desktop/hushh social card/hushh-gold-pass-mvp/src/app/api/claim/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:g,staticGenerationAsyncStorage:_,serverHooks:f,headerHooks:I,staticGenerationBailout:v}=h,w="/api/claim/route";function j(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:_})}},6517:(e,t,r)=>{r.d(t,{p:()=>s});var a=r(9224);(0,a.eI)("https://ntwdvvzjkmabujwxlzej.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50d2R2dnpqa21hYnVqd3hsemVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE3MTM4NTcsImV4cCI6MjA0NzI4OTg1N30.vQCDCT-yJjOhBjCvJk7Q5mJGwpMjkKHqo7LDZgG3lBI");let s=(0,a.eI)("https://ntwdvvzjkmabujwxlzej.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}})},5635:(e,t,r)=>{r.d(t,{pq:()=>s,Ux:()=>i,AH:()=>c,QB:()=>o,Jj:()=>m,D:()=>n,IR:()=>u,Tl:()=>l});let a=require("crypto");function s(e){let t=e.email.toLowerCase().trim(),r=e.name.trim().replace(/\s+/g," "),a=function(e){let t=e.replace(/\D/g,"");return 10===t.length?`+1${t}`:11===t.length&&t.startsWith("1")?`+1${t.substring(1)}`:null}(e.phone);return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)&&r.trim().length>0&&a?{name:r,email:t,phone_e164:a}:null}function n(e){let t=process.env.UID_SECRET_SALT;if(!t)throw Error("UID_SECRET_SALT environment variable is required");let r=e.name.toLowerCase(),s=`${e.email}|${e.phone_e164}|${r}`,n=(0,a.createHmac)("sha256",t);n.update(s);let i=n.digest().subarray(0,20),o=0n;for(let e=0;e<i.length;e++)o=(o<<8n)+BigInt(i[e]);return o.toString(36)}function i(){return(0,a.randomBytes)(8).toString("hex")}function o(){return(0,a.randomBytes)(4).toString("hex")}function u(e){return(0,a.createHash)("sha256").update(e).digest("hex")}function l(e,t){return u(e)===t}function c(e,t){let r=process.env.NEXT_PUBLIC_APP_URL||"https://hushh-gold-pass-mvp.vercel.app";return{public_url:`${r}/u/${e}`,profile_url:`${r}/complete/${e}?token=${t}`}}function m(e){let t=process.env.NEXT_PUBLIC_APP_URL||"https://hushh-gold-pass-mvp.vercel.app";return`${t}/s/${e}`}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[638,206,224],()=>r(2276));module.exports=a})();